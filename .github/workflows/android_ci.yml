# .github/workflows/android_ci.yml

name: Android CI (Pull Request & Push)

on:
  # 1. Pull Request 발생 시 (가장 중요)
  pull_request:
    branches: [ "main", "develop" ]
    types: [ opened, synchronize, reopened ] # PR이 열릴 때, 동기화될 때, 다시 열릴 때 실행
  # 2. 특정 브랜치에 Push 발생 시 (보호된 브랜치에 직접 커밋 시)
  push:
    branches: [ "main", "develop" ]

# 워크플로우에서 사용할 환경 변수 정의
env:
  BUILD_GRADLEW_PATH: ./gradlew
  # JDK 버전 설정
  JAVA_VERSION: '17'
  # Gradle Caching을 위한 키 설정
  GRADLE_CACHE_KEY: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

jobs:
  # =======================================================
  # 1. Build & Test Job (가장 기본적인 필수 검사)
  # =======================================================
  build_and_test:
    name: Build & Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      # Gradle 캐시 설정 (빌드 속도 향상)
      - name: Setup Gradle Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ env.GRADLE_CACHE_KEY }}
          restore-keys: ${{ env.GRADLE_CACHE_KEY }}
          
      # Java 환경 설정
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          
      # 권한 설정 (필요한 경우)
      - name: Grant Execute Permission to Gradlew
        run: chmod +x ${{ env.BUILD_GRADLEW_PATH }}
        
      # 1-1. Build (빌드 검사)
      - name: Check Build
        run: ${{ env.BUILD_GRADLEW_PATH }} assembleDebug -x test -x lint # 빌드만 먼저 확인
        
      # 1-2. Unit Tests (단위 테스트 검사)
      - name: Run Unit Tests
        run: ${{ env.BUILD_GRADLEW_PATH }} testDebugUnitTest
        
      # 1-3. Test Report (테스트 결과 보고 - 선택 사항)
      - name: Publish Test Report
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: app/build/reports/tests/debug/
          
  # =======================================================
  # 2. Lint Job (코드 품질 검사)
  # =======================================================
  lint_check:
    name: Lint & Code Analysis
    runs-on: ubuntu-latest
    needs: build_and_test # 빌드 및 테스트가 성공한 후에만 실행
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Gradle Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ env.GRADLE_CACHE_KEY }}
          restore-keys: ${{ env.GRADLE_CACHE_KEY }}
          
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          
      - name: Grant Execute Permission to Gradlew
        run: chmod +x ${{ env.BUILD_GRADLEW_PATH }}
        
      # 2-1. Lint 검사
      - name: Run Android Lint Check
        run: ${{ env.BUILD_GRADLEW_PATH }} lintDebug
        
      # 2-2. Lint Report (결과 보고 - 선택 사항)
      - name: Publish Lint Report
        uses: actions/upload-artifact@v4
        with:
          name: lint-results
          path: app/build/reports/lint-results-debug.xml
